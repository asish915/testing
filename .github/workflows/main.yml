name: Automation of Terraform and deployment on EC2

on:
  push:
    branches:
      - main

variables:
   AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
   AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
   AWS_REGION: ${{ secrets.AWS_REGION }}

before_script:
  - echo "Setting up Terraform environment"
  - terraform --version
  - echo "Initializing Terraform"
  - terraform init

stages:
  - validate
  - plan
  - apply
  - deploy

jobs:
  validate:
    stage: validate
    script: 
        - terraform validate

  plan:
    stage: plan
    dependencies:
        - validate
    script: 
        - terraform plan -out="planfile"
    artifacts:
        paths:
          - planfile

  apply:
    stage: apply
    dependencies:
        - plan
    script: 
        - terraform apply -auto-approve "planfile"


  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout source code
      uses: actions/checkout@v3

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Install dependencies & build
      working-directory: vite-app
      run: |
        npm install
        npm run build

    - name: Zip build output
      run: |
        cd vite-app/dist
        zip -r ../../vite-app.zip .

    - name: Upload to S3
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ secrets.AWS_REGION }}

    - name: Upload zip to S3
      run: |
        aws s3 cp vite-app.zip s3://${{ secrets.S3_BUCKET }}/vite-app.zip

    - name: Prepare SSH Key
      run: |
        echo "${{ secrets.EC2_KEY }}" | base64 -d > ec2-key.pem
        chmod 600 ec2-key.pem

    - name: Deploy to EC2
      run: |
        ssh -o StrictHostKeyChecking=no -i ec2-key.pem ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
          sudo yum install -y unzip aws-cli
          aws s3 cp s3://${{ secrets.S3_BUCKET }}/vite-app.zip /home/${{ secrets.EC2_USER }}/vite-app.zip
          unzip -o /home/${{ secrets.EC2_USER }}/vite-app.zip -d /home/${{ secrets.EC2_USER }}/vite-app
          sudo rm -rf /usr/share/nginx/html/*
          sudo cp -r /home/${{ secrets.EC2_USER }}/vite-app/* /usr/share/nginx/html/
          sudo systemctl restart nginx
        EOF
